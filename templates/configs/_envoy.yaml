{{- define "titan-mesh-helm-lib-chart.configs.envoy" }}
  {{- $titanSideCars := .titanSideCars }}
  {{- $appName := .appName }}
  {{- $releaseNamespace := .releaseNamespace }}
  {{- $chartName := .chartName }}
  {{- $envoy := $titanSideCars.envoy }}
  {{- $supportPathConfigSource := $envoy.supportPathConfigSource | default false }}
  {{- $envoyAdminPort := $envoy.adminPort | default "10000"  }}
  {{- $envoyStatsPort := $envoy.statsPort | default "8126"  }}
  {{- $envoyStatsFlushInterval := $envoy.statsFlushInterval | default "30s"  }}
  {{- $clusters := $envoy.clusters  }}
  {{- if not $clusters }}
    {{- fail ".Values.titanSideCars.envoy.clusters is required" }}
  {{- end }}
  {{- if not (index $clusters "local-myapp") }}
    {{- fail ".Values.titanSideCars.envoy.clusters.local-myapp is required" }}
  {{- end }}
  {{- $ingress := $titanSideCars.ingress  }}
  {{- $egress := $titanSideCars.egress  }}
  {{- $ingressEnabled := ternary $ingress.enabled true (hasKey $ingress "enabled") -}}
  {{- $egressEnabled := ternary $egress.enabled true (hasKey $egress "enabled") -}}
  {{- if or $ingressEnabled $egressEnabled }}
    {{- $useDynamicConfiguration := $envoy.useDynamicConfiguration | default false }}
    {{- if $useDynamicConfiguration }}
      {{- $envoyConfigFolder := $envoy.configFolder | default "/envoy/config" }}
envoy.yaml: |
  node:
    cluster: {{ $appName }}
    id: {{ printf "%s-id" $appName }}

  dynamic_resources:
        {{- if $supportPathConfigSource }}
    cds_config:
      path_config_source: 
        path: {{ printf "%s/cds.yaml" (trimSuffix "/" $envoyConfigFolder) }}
        watched_directory: 
          path: {{ (trimSuffix "/" $envoyConfigFolder) }}
    lds_config:
      path_config_source:
        path: {{ printf "%s/lds.yaml" (trimSuffix "/" $envoyConfigFolder) }}
        watched_directory: 
          path: {{ (trimSuffix "/" $envoyConfigFolder) }}
         {{- else }}
    cds_config:
      path: {{ printf "%s/cds.yaml" (trimSuffix "/" $envoyConfigFolder) }}
    lds_config:
      path: {{ printf "%s/lds.yaml" (trimSuffix "/" $envoyConfigFolder) }}
         {{- end }}
  admin:
    access_log_path: /dev/stdout
    address:
      socket_address:
        address: 0.0.0.0
        port_value:  {{ $envoyAdminPort }}
  stats_flush_interval: {{ $envoyStatsFlushInterval }}
  stats_sinks:
    - name: envoy.stat_sinks.statsd
      typed_config:
        "@type": type.googleapis.com/envoy.config.metrics.v3.StatsdSink
        address:
          socket_address:
            address: 127.0.0.1
            port_value: {{ $envoyStatsPort }}
            protocol: UDP

lds.yaml: |
  resources:
      {{- include "titan-mesh-helm-lib-chart.envoy.listeners" (dict "titanSideCars" $titanSideCars "releaseNamespace" $releaseNamespace "chartName" $chartName "useDynamicConfiguration" $useDynamicConfiguration "appName" $appName) }}

cds.yaml: |
  resources:
      {{- include "titan-mesh-helm-lib-chart.envoy.clusters" (dict "titanSideCars" $titanSideCars "releaseNamespace" $releaseNamespace "chartName" $chartName "useDynamicConfiguration" $useDynamicConfiguration) }}
      
    {{- else -}}
envoy.yaml: |
  admin:
    access_log_path: /dev/stdout
    address:
      socket_address:
        address: 0.0.0.0
        port_value:  {{ $envoyAdminPort }}
  stats_flush_interval: {{ $envoyStatsFlushInterval }}
  stats_sinks:
    - name: envoy.stat_sinks.statsd
      typed_config:
        "@type": type.googleapis.com/envoy.config.metrics.v3.StatsdSink
        address:
          socket_address:
            address: 127.0.0.1
            port_value: {{ $envoyStatsPort }}
            protocol: UDP
      {{- if $envoy.statsConfigRaw }}
  stats_config:
      {{- $envoy.statsConfigRaw | toYaml | nindent 2 }}
      {{- end }}
  static_resources:
    clusters:
      {{- include "titan-mesh-helm-lib-chart.envoy.clusters" (dict "titanSideCars" $titanSideCars "releaseNamespace" $releaseNamespace "chartName" $chartName "useDynamicConfiguration" $useDynamicConfiguration) }}
    listeners:
      {{- include "titan-mesh-helm-lib-chart.envoy.listeners" (dict "titanSideCars" $titanSideCars "releaseNamespace" $releaseNamespace "chartName" $chartName "useDynamicConfiguration" $useDynamicConfiguration "appName" $appName) }}
    {{- end }}
  {{- end }}
{{- end }}
