{{- define "titan-mesh-helm-lib-chart.envoy.canary.cluster" -}}
  {{- $envoy := .envoy -}}
  {{- $service := .service -}}
  {{- $appName := .appName -}}
  {{- $clusters := $envoy.canaryClusters -}}
  {{- $clusterReleaseLabel := "" -}}
  {{- $clusterReleaseBaseLabel := "0000-00-0" -}}
  {{- $appInfo := include "titan-mesh-helm-lib-chart.envoy.canary.service" $appName | fromJson -}}
  {{- $cluster := get $clusters $service -}}
  {{- if $cluster -}}
    {{- $sortedReleases := keys $cluster | sortAlpha -}}
    {{- if ne $appInfo.label "" -}}
      {{- if has $appInfo.label $sortedReleases -}}
        {{- $clusterReleaseLabel = printf "-%s" $appInfo.label -}}
      {{- else if gt (len $sortedReleases) 1 -}}
        {{- range $sortedReleases -}}
          {{- if ne . $clusterReleaseBaseLabel -}}
            {{- if le . $appInfo.label -}}
              {{- $clusterReleaseLabel = printf "-%s" . -}}
            {{- else if eq $clusterReleaseLabel "" -}}
              {{- $clusterReleaseLabel = printf "-%s" . -}}
            {{- end -}}
          {{- end -}}
        {{- end -}}
      {{- else if ne (index $sortedReleases 0) $clusterReleaseBaseLabel -}}
        {{- $clusterReleaseLabel = printf "-%s" (index $sortedReleases 0) -}}
      {{- end -}}
    {{- else -}}
      {{- if ne (index $sortedReleases 0) $clusterReleaseBaseLabel -}}
        {{- $clusterReleaseLabel = printf "-%s" (index $sortedReleases 0) -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  {{- printf "%s%s" $service $clusterReleaseLabel -}}
{{- end -}}