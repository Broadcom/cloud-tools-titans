{{- define "titan-mesh-helm-lib-chart.envoy.canary.clusters" -}}
  {{- $titanSideCars := .titanSideCars -}}
  {{- $envoy := $titanSideCars.envoy -}}
  {{- $clusters := $envoy.clusters -}}
  {{- $icdmClusters := .icdmClusters -}}
  {{- $releaseClusters := dict -}}
  {{- $localApp := index $clusters "local-myapp" -}}
  {{- $remoteApp := index $clusters "remote-myapp" -}}
  {{- $releaseBaseLabel := "0000-00-0" -}}
  {{- $releaseLabelPattern := "^[a-z-]+-[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9]$" -}}
  {{- range $cluster, $value := $clusters -}}
    {{- if and (ne $cluster "remote-myapp") (not (hasPrefix "local-" $cluster)) -}}
      {{- $serviceName := $cluster -}}
      {{- $releaseLabel := $releaseBaseLabel -}}
      {{- if regexMatch $releaseLabelPattern $cluster -}}
        {{- $serviceName = substr 0 (sub (len $cluster | int64 ) (len "-0000-00-0" | int64) | int ) $cluster -}}
        {{- $releaseLabel = substr (add1 (len $serviceName | int64) | int) (len $cluster) $cluster -}}
      {{- end -}}
      {{- $versionRoutes := dict "routes" $value.routes -}}
      {{- $service := get $releaseClusters $serviceName -}}
      {{- if $service -}}
        {{- $_ := set $service $releaseLabel $versionRoutes -}}
      {{- else -}}
        {{- $version := dict $releaseLabel $versionRoutes -}}
        {{- $_ := set $releaseClusters $serviceName $version -}}
      {{- end -}}
    {{- end -}}
  {{- end -}}
  {{- range $cluster, $value := $icdmClusters -}}
    {{- $serviceName := $cluster -}}
    {{- $releaseLabel := $releaseBaseLabel -}}
    {{- if regexMatch $releaseLabelPattern $cluster -}}
      {{- $serviceName = substr 0 (sub (len $cluster | int64) (len "-0000-00-0" | int64) | int) $cluster -}}
      {{- $releaseLabel = substr (add1 (len $serviceName | int64) | int) (len $cluster | int) $cluster -}}
    {{- end -}}
    {{- $routes := list -}}
    {{- range $value.routes -}}
      {{- $match := dict .match .uri -}}
      {{- $route := dict "match" $match -}}
      {{- $routes = append $routes $route -}}
    {{- end -}}
    {{- $versionRoutes := dict "routes" $routes -}}
    {{- $service := get $releaseClusters $serviceName -}}
    {{- if $service -}}
      {{- $_ := set $service $releaseLabel $versionRoutes -}}
    {{- else -}}
      {{- $version := dict $releaseLabel $versionRoutes -}}
      {{- $_ := set $releaseClusters $serviceName $version -}}
    {{- end -}}
  {{- end -}}
  {{- $releaseClusters | toJson  -}}
{{- end -}}